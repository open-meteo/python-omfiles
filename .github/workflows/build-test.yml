name: Build and Test

on:
  push:
    branches:
      - main
    tags:
      - "*"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    uses: ./.github/workflows/lint.yml

  rust_tests:
    name: Rust tests - ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.runner }}
    container: ${{ matrix.platform.container }}
    strategy:
      matrix:
        platform:
          - name: Linux x86_64
            runner: ubuntu-24.04
          - name: Linux ARM64
            runner: ubuntu-24.04-arm
          - name: Windows x64
            runner: windows-latest
          - name: Windows ARM64
            runner: windows-11-arm
          - name: macOS x86_64
            runner: macos-15-intel
          - name: macOS ARM64
            runner: macos-15
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/cache-rust-build
      - uses: ./.github/actions/install-uv
      - uses: ./.github/actions/install-python-deps
      - uses: ./.github/actions/run-cargo-tests

  build:
    needs: rust_tests
    name: Build Wheels - ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.runner }}
    container: ${{ matrix.platform.container }}
    strategy:
      matrix:
        platform:
          - name: linux-x86_64
            runner: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            before-script: python3 -m ensurepip && cat /etc/os-release && yum install clang -y
            manylinux: "2_28"
            is-musl: false

          - name: linux-aarch64
            runner: ubuntu-24.04
            target: aarch64-unknown-linux-gnu
            skip_tests: true
            before-script: |
              apt-get update && \
              apt-get install --assume-yes --no-install-recommends crossbuild-essential-arm64
            manylinux: "2_28"
            is-musl: false

          - name: linux-musl-x86_64
            runner: ubuntu-24.04
            target: x86_64-unknown-linux-musl
            container: docker://messense/rust-musl-cross:x86_64-musl
            before-script: cat /etc/os-release && apt install clang -y
            manylinux: musllinux_1_2
            is-musl: true

          - name: windows-x64
            runner: windows-latest
            target: x86_64-pc-windows-msvc
            is-musl: false

          - name: windows-arm64
            runner: windows-11-arm
            target: aarch64-pc-windows-msvc
            is-musl: false

          - name: macos-x86_64
            runner: macos-15-intel
            target: x86_64-apple-darwin
            is-musl: false

          - name: macos-arm64
            runner: macos-15
            target: aarch64-apple-darwin
            is-musl: false
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/cache-rust-build
      - uses: ./.github/actions/build-wheel
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          manylinux: ${{ matrix.platform.manylinux }}
          before-script-linux: ${{ matrix.platform.before-script }}
      - uses: ./.github/actions/upload-wheels
        with:
          name: wheels-${{ matrix.platform.name }}
          path: dist

  sdist:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - name: Build sdist
        uses: ./.github/actions/build-wheel
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: ./.github/actions/upload-wheels
        with:
          name: wheels-sdist
          path: dist

  test:
    needs: build
    name: Test - ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.runner }}
    strategy:
      fail-fast: false
      matrix:
        config:
          # Platform tests with Python 3.12
          - name: Linux x86_64
            runner: ubuntu-24.04
            platform-name: linux-x86_64
            python-version: "3.12"
            is-min-deps: false

          - name: Linux ARM64
            runner: ubuntu-24.04-arm
            platform-name: linux-aarch64
            python-version: "3.12"
            is-min-deps: false

          - name: Windows
            runner: windows-latest
            platform-name: windows-x64
            python-version: "3.12"
            is-min-deps: false

          - name: Windows ARM64
            runner: windows-11-arm
            platform-name: windows-arm64
            python-version: "3.12"
            is-min-deps: false

          - name: macOS x86_64
            runner: macos-15-intel
            platform-name: macos-x86_64
            python-version: "3.12"
            is-min-deps: false

          - name: macOS ARM64
            runner: macos-15
            platform-name: macos-arm64
            python-version: "3.12"
            is-min-deps: false

          # Additional Python versions for Linux x86_64
          - name: Python 3.10
            runner: ubuntu-24.04
            platform-name: linux-x86_64
            python-version: "3.10"
            is-min-deps: false

          - name: Python 3.11
            runner: ubuntu-24.04
            platform-name: linux-x86_64
            python-version: "3.11"
            is-min-deps: false

          - name: Python 3.13
            runner: ubuntu-24.04
            platform-name: linux-x86_64
            python-version: "3.13"
            is-min-deps: false

          - name: Python 3.14
            runner: ubuntu-24.04
            platform-name: linux-x86_64
            python-version: "3.14"
            is-min-deps: false

          # - name: Python 3.15
          #   runner: ubuntu-24.04
          #   platform-name: linux-x86_64
          #   python-version: "3.15"
          #   is-min-deps: false

          # Minimum dependencies test
          - name: Min Dependencies
            runner: ubuntu-24.04
            platform-name: linux-x86_64
            python-version: "3.10"
            is-min-deps: true
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/install-uv
        with:
          python-version: ${{ matrix.config.python-version }}
      - uses: ./.github/actions/download-wheels
        with:
          name: wheels-${{ matrix.config.platform-name }}
          path: dist
      - uses: ./.github/actions/run-python-tests
        with:
          min-deps: ${{ matrix.config.is-min-deps }}

  test-musl:
    needs: build
    name: Test - Linux Musl
    runs-on: ubuntu-24.04
    container: ghcr.io/astral-sh/uv:0.9.11-alpine
    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        shell: sh
        run: |
          apk add tar python3 py3-pip py3-psutil gcc python3-dev musl-dev linux-headers

      - uses: ./.github/actions/install-uv
        with:
          python-version: "3.12"
      - uses: ./.github/actions/download-wheels
        with:
          name: wheels-linux-musl-x86_64
          path: dist

      - name: Run musl tests
        uses: ./.github/actions/run-python-tests
